{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sustainability Dashboard</title>

<!-- Fonts & Icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

<!-- JS Libraries -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

<style>
body { font-family: 'Roboto', sans-serif; margin:0; background:#f0f2f5; color:#333; }
h1 { text-align:center; color:#1b5e20; margin:30px 0; font-weight:700; }
.top-summary { display:flex; justify-content:center; flex-wrap:wrap; gap:20px; margin-bottom:30px; }
.summary-card { flex:1 1 220px; background: linear-gradient(135deg,#81c784,#66bb6a); color:#fff; border-radius:20px; padding:25px 20px; text-align:center; box-shadow:0 12px 25px rgba(0,0,0,0.12); transition: transform 0.3s ease; }
.summary-card:hover { transform: translateY(-5px); }
.summary-card i { font-size:35px; margin-bottom:10px; }
.tabs { display:flex; justify-content:center; flex-wrap:wrap; margin-bottom:30px; }
.tab { padding:12px 25px; margin:5px; border-radius:25px; cursor:pointer; background:#90caf9; color:#fff; font-weight:500; display:flex; align-items:center; transition:all 0.3s ease; }
.tab i { margin-right:8px; }
.tab:hover { background:#42a5f5; transform:translateY(-2px); }
.tab.active { background:#1e88e5; }
.tab-content { display:none; text-align:center; margin:0 auto 40px auto; }
.tab-content.active { display:block; }
.chart-container { display:flex; justify-content:center; flex-wrap:wrap; gap:30px; }
.chart-card { flex:1 1 45%; background:#fff; border-radius:20px; padding:25px; box-shadow:0 12px 25px rgba(0,0,0,0.12); transition:transform 0.3s ease; }
.chart-card:hover { transform:translateY(-5px); }
.chart-card canvas { height:350px !important; }
select { padding:8px 12px; font-size:15px; margin:8px 5px; border-radius:8px; border:1px solid #ccc; transition: all 0.2s ease; }
select:hover { border-color:#1e88e5; }
h2 { color:#1b5e20; font-weight:600; margin-bottom:20px; }
</style>
</head>
<body>

<h1><i class="fa fa-tree"></i> Sustainability Dashboard</h1>

<div class="top-summary">
    <div class="summary-card" style="background: linear-gradient(135deg,#42a5f5,#1e88e5);">
        <i class="fa fa-sliders-h"></i>
        <h3>Select Year & Warehouse</h3>
        <form id="filterForm" method="GET">
            <select id="yearSelect" name="year">
                {% for y in years %}
                    <option value="{{ y }}" {% if y == selected_year %}selected{% endif %}>{{ y }}</option>
                {% endfor %}
            </select>
            <select id="warehouseSelect" name="warehouse">
                {% for w in warehouses %}
                    <option value="{{ w }}" {% if w == selected_warehouse %}selected{% endif %}>{{ w }}</option>
                {% endfor %}
            </select>
        </form>
    </div>

    <div class="summary-card">
        <i class="fa fa-cloud"></i>
        <h3>Total CO₂ Emissions</h3>
        <p id="kpiCo2">—</p>
    </div>

    <div class="summary-card" style="background: linear-gradient(135deg, #4db6ac, #26a69a);">
        <i class="fa fa-bolt"></i>
        <h3>Energy Consumption</h3>
        <p id="kpiEnergy">—</p>
    </div>

    <div class="summary-card" style="background: linear-gradient(135deg, #ba68c8, #ab47bc);">
        <i class="fa fa-leaf"></i>
        <h3>Renewable Energy</h3>
        <p id="kpiRenewable">—</p>
    </div>
</div>

<!-- Tabs -->
<div class="tabs">
    <div class="tab active" onclick="showTab('co2')"><i class="fa fa-cloud"></i>CO₂ Emissions</div>
    <div class="tab" onclick="showTab('energy')"><i class="fa fa-bolt"></i>Energy</div>
    <div class="tab" onclick="showTab('renewable')"><i class="fa fa-leaf"></i>Renewable</div>
</div>

<!-- Tab Contents -->
<div id="co2" class="tab-content active">
    <h2>CO₂ Emissions – Warehouse {{ selected_warehouse }} in {{ selected_year }}</h2>
    <div class="chart-container">
        <div class="chart-card"><canvas id="co2Bar"></canvas></div>
        <div class="chart-card"><canvas id="co2Pie"></canvas></div>
    </div>
</div>

<div id="energy" class="tab-content">
    <h2>Energy Consumption – Warehouse {{ selected_warehouse }} in {{ selected_year }}</h2>
    <div class="chart-container">
        <div class="chart-card"><canvas id="energyBar"></canvas></div>
        <div class="chart-card"><canvas id="energyPie"></canvas></div>
    </div>
</div>

<div id="renewable" class="tab-content">
    <h2>Renewable Energy – Warehouse {{ selected_warehouse }} in {{ selected_year }}</h2>
    <div class="chart-container">
        <div class="chart-card"><canvas id="renewableBar"></canvas></div>
        <div class="chart-card"><canvas id="renewablePie"></canvas></div>
    </div>
</div>

<!-- Hidden JSON Data -->
<script id="dataByYearJSON" type="application/json">
{
    "2023": {
        "Warehouse A": {"co2_total":320, "energy_total":450, "renewable_total":120},
        "Warehouse B": {"co2_total":280, "energy_total":380, "renewable_total":150}
    },
    "2024": {
        "Warehouse A": {"co2_total":310, "energy_total":430, "renewable_total":130},
        "Warehouse B": {"co2_total":290, "energy_total":400, "renewable_total":160}
    }
}
</script>

<script>
function showTab(tabId){
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    event.currentTarget.classList.add('active');
    document.getElementById(tabId).classList.add('active');
}

let dataByYear = {};
try { dataByYear = JSON.parse(document.getElementById('dataByYearJSON').textContent.trim()); } catch(err){ dataByYear={}; }

const yearSelect = document.getElementById('yearSelect');
const warehouseSelect = document.getElementById('warehouseSelect');
const kpiCo2 = document.getElementById('kpiCo2');
const kpiEnergy = document.getElementById('kpiEnergy');
const kpiRenewable = document.getElementById('kpiRenewable');

const chartOptions = { responsive:true, plugins:{ datalabels:{ anchor:'end', align:'top', color:'#111', font:{weight:'700'} } }, scales:{ y:{ beginAtZero:true } } };

const co2Bar = new Chart(document.getElementById('co2Bar'), { type:'bar', data:{labels:[''],datasets:[{label:'CO₂',data:[0],backgroundColor:'#ff7043',borderRadius:15}]}, options:chartOptions, plugins:[ChartDataLabels] });
const co2Pie = new Chart(document.getElementById('co2Pie'), { type:'pie', data:{labels:['Used','Remaining'],datasets:[{data:[0,0],backgroundColor:['#ff7043','#42a5f5']}]}, options:{plugins:{datalabels:{color:'#fff', formatter: (val, ctx) => { return val.toFixed(1) + '%'; }}}}, plugins:[ChartDataLabels] });

const energyBar = new Chart(document.getElementById('energyBar'), { type:'bar', data:{labels:[''],datasets:[{label:'Energy',data:[0],backgroundColor:'#26a69a',borderRadius:15}]}, options:chartOptions, plugins:[ChartDataLabels] });
const energyPie = new Chart(document.getElementById('energyPie'), { type:'pie', data:{labels:['Used','Remaining'],datasets:[{data:[0,0],backgroundColor:['#26a69a','#90caf9']}]}, options:{plugins:{datalabels:{color:'#fff', formatter: (val, ctx) => { return val.toFixed(1) + '%'; }}}}, plugins:[ChartDataLabels] });

const renewableBar = new Chart(document.getElementById('renewableBar'), { type:'bar', data:{labels:[''],datasets:[{label:'Renewable',data:[0],backgroundColor:'#66bb6a',borderRadius:15}]}, options:chartOptions, plugins:[ChartDataLabels] });
const renewablePie = new Chart(document.getElementById('renewablePie'), { type:'pie', data:{labels:['Used','Remaining'],datasets:[{data:[0,0],backgroundColor:['#66bb6a','#ef5350']}]}, options:{plugins:{datalabels:{color:'#fff', formatter: (val, ctx) => { return val.toFixed(1) + '%'; }}}}, plugins:[ChartDataLabels] });

function updateDashboard(year, warehouse){
    if(!year || !warehouse || !dataByYear[year] || !dataByYear[year][warehouse]) return;
    const d = dataByYear[year][warehouse];

    kpiCo2.textContent = d.co2_total;
    kpiEnergy.textContent = d.energy_total;
    kpiRenewable.textContent = d.renewable_total;

    const co2Max = 500;      // example max
    const energyMax = 500;
    const renewableMax = 200;

    const co2Used = d.co2_total;
    const energyUsed = d.energy_total;
    const renewableUsed = d.renewable_total;

    const co2Remain = Math.max(co2Max - co2Used,0);
    const energyRemain = Math.max(energyMax - energyUsed,0);
    const renewableRemain = Math.max(renewableMax - renewableUsed,0);

    // Update bar charts
    co2Bar.data.labels=[warehouse]; co2Bar.data.datasets[0].data=[co2Used];
    energyBar.data.labels=[warehouse]; energyBar.data.datasets[0].data=[energyUsed];
    renewableBar.data.labels=[warehouse]; renewableBar.data.datasets[0].data=[renewableUsed];

    // Update pie charts
    co2Pie.data.datasets[0].data=[co2Used, co2Remain];
    energyPie.data.datasets[0].data=[energyUsed, energyRemain];
    renewablePie.data.datasets[0].data=[renewableUsed, renewableRemain];

    co2Bar.update(); co2Pie.update(); energyBar.update(); energyPie.update(); renewableBar.update(); renewablePie.update();
}

// Init
updateDashboard(yearSelect.value, warehouseSelect.value);

// Event listeners
yearSelect.addEventListener('change',()=>{ updateDashboard(yearSelect.value, warehouseSelect.value); });
warehouseSelect.addEventListener('change',()=>{ updateDashboard(yearSelect.value, warehouseSelect.value); });
</script>

</body>
</html>
